{% extends "base.html" %}

{% block title %}PDV - Vendas - Sistema de Caixa{% endblock %}

{% block extra_css %}
<style>
    /* Estilo para a lista de itens da venda (carrinho) */
    .carrinho-lista {
        max-height: 400px;
        overflow-y: auto;
    }
    .total-display {
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    /* Estilo para info do produto */
    #produto-info {
        min-height: 200px; /* Aumenta altura para caber a imagem */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    #produto-info-img {
        max-height: 120px;
        max-width: 100%;
        object-fit: contain;
        margin-bottom: 10px;
    }

    /* ======================================================= */
    /* INÍCIO DO NOVO CSS (MODAL DE BUSCA)           */
    /* ======================================================= */
    #lista-resultados-busca {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Estilo para o item da lista de busca */
    .resultado-item-busca img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 5px;
    }
    
    .resultado-item-busca .info {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .resultado-item-busca .info .nome {
        font-weight: bold;
        color: #0d6efd; /* Azul do Bootstrap */
    }
    
    .resultado-item-busca .info .detalhes {
        font-size: 0.85rem;
        color: #6c757d; /* Cinza do Bootstrap */
    }
    
    .resultado-item-busca .preco {
        font-size: 1.1rem;
        font-weight: bold;
        color: #198754; /* Verde do Bootstrap */
        white-space: nowrap; /* Impede que o preço quebre a linha */
    }
    /* ======================================================= */
    /* FIM DO NOVO CSS (MODAL DE BUSCA)            */
    /* ======================================================= */
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-shopping-cart"></i> PDV - Ponto de Venda</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <span class="badge bg-success fs-6">
            <i class="fas fa-lock-open"></i> Caixa Aberto (Saldo Inicial: R$ {{ "%.2f"|format(movimento_atual.saldo_inicial) }})
        </span>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-barcode"></i> Lançar Produto</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="codigo_barras" class="form-label">Código de Barras ou ID:</label>
                    <input type="text" class="form-control form-control-lg" id="codigo_barras" 
                           placeholder="Leia o código ou digite..." autofocus>
                </div>
                
                <div id="produto-info" class="text-center p-3 bg-light rounded">
                    <p class="text-muted">Aguardando produto...</p>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6 mb-2">
                        <label for="quantidade" class="form-label">Quantidade:</label>
                        <input type="number" class="form-control" id="quantidade" value="1" min="1">
                    </div>
                    <div class="col-md-6 d-grid align-items-end">
                        <button class="btn btn-primary" id="btn-adicionar">
                            <i class="fas fa-plus"></i> Adicionar (Enter)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">Atalhos</h6>
                <p><kbd>Enter</kbd> - Adicionar Item</p>
                <p><kbd>F2</kbd> - Buscar Produto por Nome</p>
                <p><kbd>F6</kbd> - Finalizar Venda</p>
                <p><kbd>F3</kbd> - Cancelar Venda</p>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list-ul"></i> Itens da Venda</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive carrinho-lista">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Produto</th>
                                <th scope="col">Qtd.</th>
                                <th scope="col">Vl. Unit.</th>
                                <th scope="col">Subtotal</th>
                                <th scope="col">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="carrinho-tbody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row total-display p-3 align-items-center">
                    <div class="col-md-6">
                        <h4>Total de Itens: <span id="total-itens" class="fw-bold">0</span></h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <h2 class="mb-0">Total: <span id="total-venda" class="fw-bold text-success">R$ 0.00</span></h2>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success btn-lg" id="btn-finalizar" data-bs-toggle="modal" data-bs-target="#modalFinalizar">
                        <i class="fas fa-check"></i> Finalizar Venda (F6)
                    </button>
                    <button class="btn btn-danger" id="btn-cancelar">
                        <i class="fas fa-times"></i> Cancelar Venda (F3)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBuscarProduto" tabindex="-1" aria-labelledby="modalBuscarProdutoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalBuscarProdutoLabel"><i class="fas fa-search"></i> Buscar Produto por Nome</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="input-busca-nome" class="form-label">Digite o nome ou código do produto:</label>
                    <input type="text" class="form-control form-control-lg" id="input-busca-nome" placeholder="Ex: Arroz ou 789...">
                </div>
                <hr>
                <div id="lista-resultados-busca">
                    <p class="text-center text-muted">Aguardando digitação (mín. 2 caracteres)...</p>
                    </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalFinalizarLabel"><i class="fas fa-check"></i> Finalizar Venda</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h4 class="mb-3"><i class="fas fa-credit-card"></i> Adicionar Pagamento</h4>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label for="forma_pagamento_add" class="form-label">Forma de Pagamento:</label>
                                <select class="form-select" id="forma_pagamento_add">
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cartao">Cartão</option>
                                    <option value="pix">PIX</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="valor_pagamento_add" class="form-label">Valor (R$):</label>
                                <input type="number" step="0.01" class="form-control" id="valor_pagamento_add" placeholder="0.00">
                            </div>
                        </div>
                        <div class="d-grid mb-4">
                            <button class="btn btn-info" id="btn-adicionar-pagamento">
                                <i class="fas fa-plus"></i> Adicionar Pagamento
                            </button>
                        </div>
                        
                        <h5 class="mb-3"><i class="fas fa-file-invoice"></i> Pagamentos Registrados</h5>
                        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                            <table class="table table-striped table-sm mb-0">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Forma</th>
                                        <th>Valor (R$)</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="pagamentos-tbody">
                                    </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info mt-3" id="campo-pix-qrcode" style="display: none;">
                            <p class="mb-1 fw-bold">Pague com PIX</p>
                            <p class="text-muted" style="font-size: 0.9rem;">
                                Aponte a câmera para o QR Code (Valor Pix: R$ <span id="modal-total-pix">0.00</span>).
                            </p>
                            <img src="{{ url_for('static', filename='images/qrcode_pix_loja.png') }}" 
                                 alt="QR Code PIX da Loja" 
                                 class="img-fluid rounded border" 
                                 style="max-width: 150px;">
                        </div>

                    </div>
                    
                    <div class="col-md-6 bg-light p-4 rounded d-flex flex-column justify-content-between">
                        <div>
                            <h3 class="mb-3 text-secondary">Total da Venda:</h3>
                            <h1 id="modal-total-venda" class="display-5 fw-bold text-dark">R$ 0.00</h1>
                            <hr>
                            
                            <h3 class="mb-3 text-secondary">Total Pago:</h3>
                            <h1 id="modal-total-pago" class="display-5 fw-bold text-success">R$ 0.00</h1>
                            <hr>

                            <h3 class="mb-3 text-secondary">Troco:</h3>
                            <h1 id="modal-troco" class="display-6 fw-bold text-primary">R$ 0.00</h1>
                        </div>
                        <div class="alert mt-3" id="alerta-status">
                            Verifique se o valor pago é suficiente.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-success btn-lg" id="btn-confirmar-venda" disabled>
                    <i class="fas fa-save"></i> Confirmar Venda
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // =========================================================================
    // VARIÁVEIS DE ESTADO
    // =========================================================================
    let carrinho = []; // Armazena os itens da venda ( [{id, nome, preco, qtd, subtotal}, ...] )
    let pagamentos = []; // NOVO: Armazena os pagamentos [ {forma_pagamento: 'dinheiro', valor: 15.00}, ...]
    let produtoAtual = null; 
    
    // =========================================================================
    // ELEMENTOS DOM
    // =========================================================================
    const inputCodigoBarras = document.getElementById('codigo_barras');
    const inputQuantidade = document.getElementById('quantidade');
    const btnAdicionar = document.getElementById('btn-adicionar');
    const infoProdutoDiv = document.getElementById('produto-info');
    const carrinhoTbody = document.getElementById('carrinho-tbody');
    const totalItensSpan = document.getElementById('total-itens');
    const totalVendaSpan = document.getElementById('total-venda');
    const btnFinalizar = document.getElementById('btn-finalizar');
    const btnCancelar = document.getElementById('btn-cancelar');
    
    // --- Modal Buscar Produto ---
    const modalBusca = new bootstrap.Modal(document.getElementById('modalBuscarProduto'));
    const inputBuscaNome = document.getElementById('input-busca-nome');
    const listaResultadosBusca = document.getElementById('lista-resultados-busca');
    let buscaTypingTimer; 
    
    // --- Modal Finalizar (NOVOS e REFATORADOS) ---
    const modalFinalizarVenda = new bootstrap.Modal(document.getElementById('modalFinalizar'));
    const modalTotalVenda = document.getElementById('modal-total-venda');
    const modalTotalPago = document.getElementById('modal-total-pago'); // NOVO
    const modalTroco = document.getElementById('modal-troco');
    const btnConfirmarVenda = document.getElementById('btn-confirmar-venda');
    const alertaStatus = document.getElementById('alerta-status');

    // --- Campos de Adição de Pagamento (NOVOS) ---
    const selectFormaPagamentoAdd = document.getElementById('forma_pagamento_add');
    const inputValorPagamentoAdd = document.getElementById('valor_pagamento_add');
    const btnAdicionarPagamento = document.getElementById('btn-adicionar-pagamento');
    const pagamentosTbody = document.getElementById('pagamentos-tbody');
    const campoPixQrcode = document.getElementById('campo-pix-qrcode');
    const modalTotalPix = document.getElementById('modal-total-pix');

    // =========================================================================
    // FUNÇÕES PRINCIPAIS
    // =========================================================================

    /**
     * Busca o produto na API do backend
     */
    async function buscarProduto(forceSearch = false) {
        const codigo = inputCodigoBarras.value;

        // Adiciona uma verificação para código vazio
        if (codigo.length === 0) {
            limparInfoProduto();
            return;
        }

        try {
            const response = await fetch(`/api/produto/${codigo}`);
            
            if (!response.ok) {
                const error = await response.json();
                infoProdutoDiv.innerHTML = `<p class="text-danger fw-bold">${error.error}</p>`;
                produtoAtual = null;
                return;
            }

            const produto = await response.json();
            produtoAtual = produto; // Armazena o produto encontrado
            
            // --- ATUALIZAÇÃO PARA MOSTRAR IMAGEM ---
            let img_html = '';
            if (produto.imagem_url) {
                // A API agora retorna a URL completa
                img_html = `<img src="${produto.imagem_url}" alt="${produto.nome}" id="produto-info-img">`;
            } else {
                img_html = '<i class="fas fa-image fa-3x text-muted mb-2"></i>';
            }
            
            // Atualiza o painel de informações
            infoProdutoDiv.innerHTML = `
                ${img_html}
                <h5 class="text-primary mb-0">${produto.nome}</h5>
                <h3 class="fw-bold">R$ ${produto.preco_venda.toFixed(2)}</h3>
                <small class="text-muted">Estoque: ${produto.estoque_atual}</small>
            `;
            // ----------------------------------------
            
            // Foca na quantidade para o usuário confirmar
            inputQuantidade.focus();
            inputQuantidade.select();

        } catch (error) {
            console.error('Erro ao buscar produto:', error);
            infoProdutoDiv.innerHTML = `<p class="text-danger">Erro de conexão.</p>`;
            produtoAtual = null;
        }
    }
    
    /**
     * Adiciona o produto_atual ao carrinho
     */
    function adicionarAoCarrinho() {
        if (!produtoAtual) {
            alert('Nenhum produto selecionado. Busque um produto primeiro.');
            inputCodigoBarras.focus();
            return;
        }

        const quantidade = parseInt(inputQuantidade.value);
        if (isNaN(quantidade) || quantidade <= 0) {
            alert('Quantidade inválida.');
            return;
        }

        // Verifica se o item já está no carrinho
        const itemExistente = carrinho.find(item => item.id === produtoAtual.id);
        const estoqueAtual = produtoAtual.estoque_atual;

        if (itemExistente) {
             // 1. Verifica se a soma total não excede o estoque
             if (itemExistente.qtd + quantidade > estoqueAtual) {
                 alert(`Estoque insuficiente. Tentativa: ${itemExistente.qtd + quantidade}, Disponível: ${estoqueAtual}`);
                 return;
             }
             
            // 2. Atualiza a quantidade
            itemExistente.qtd += quantidade;
            itemExistente.subtotal = itemExistente.preco * itemExistente.qtd;
            
        } else {
            // Validação de estoque para novo item
            if (quantidade > estoqueAtual) {
                 alert(`Estoque insuficiente para ${produtoAtual.nome}. Disponível: ${estoqueAtual}`);
                 return;
            }

            // Adiciona novo item
            carrinho.push({
                id: produtoAtual.id,
                nome: produtoAtual.nome,
                preco: produtoAtual.preco_venda,
                qtd: quantidade,
                subtotal: produtoAtual.preco_venda * quantidade,
                estoque_atual: estoqueAtual 
            });
        }
        
        renderizarCarrinho();
        limparFormularioProduto();
    }
    
    /**
     * Redesenha a tabela do carrinho e os totais
     */
    function renderizarCarrinho() {
        carrinhoTbody.innerHTML = ''; // Limpa a tabela
        
        let totalVenda = 0;
        let totalItens = 0;

        carrinho.forEach((item, index) => {
            totalVenda += item.subtotal;
            totalItens += item.qtd;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.nome}</td>
                <td style="width: 100px;">
                    <input type="number" 
                           class="form-control form-control-sm text-center" 
                           value="${item.qtd}" 
                           min="1" 
                           max="${item.estoque_atual}"
                           onchange="atualizarQuantidadeItem(${item.id}, this.value)">
                </td>
                <td>R$ ${item.preco.toFixed(2)}</td>
                <td>R$ ${item.subtotal.toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removerItemCarrinho(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            carrinhoTbody.appendChild(tr);
        });

        // Atualiza os totais
        totalItensSpan.textContent = totalItens;
        totalVendaSpan.textContent = `R$ ${totalVenda.toFixed(2)}`;
        
        // Habilita/desabilita botão de finalizar
        btnFinalizar.disabled = carrinho.length === 0;

        // Sempre que o carrinho muda, atualiza o modal de pagamentos
        renderizarPagamentos();
    }

    /**
     * Atualiza a quantidade de um item já existente no carrinho
     */
    window.atualizarQuantidadeItem = function(produtoId, novaQuantidade) {
        const qtd = parseInt(novaQuantidade);
        
        // Encontra o item no array do carrinho
        const item = carrinho.find(item => item.id === produtoId);

        // Validação de estoque e quantidade
        if (isNaN(qtd) || qtd <= 0) {
            alert("A quantidade deve ser maior que zero.");
            renderizarCarrinho(); 
            return;
        }

        if (item && qtd > item.estoque_atual) {
             alert(`Estoque insuficiente. Tentativa: ${qtd}, Disponível: ${item.estoque_atual}`);
             renderizarCarrinho();
             return;
        }


        if (item) {
            // Atualiza quantidade e recalcula subtotal
            item.qtd = qtd;
            item.subtotal = item.preco * item.qtd;
            
            // Atualiza a interface
            renderizarCarrinho();
        }
    };
    
    /**
     * Remove um item do carrinho
     */
    window.removerItemCarrinho = function(produtoId) {
        carrinho = carrinho.filter(item => item.id !== produtoId);
        renderizarCarrinho();
    }
    
    /**
     * Limpa o formulário de busca de produto
     */
    function limparFormularioProduto() {
        produtoAtual = null;
        inputCodigoBarras.value = '';
        inputQuantidade.value = '1';
        infoProdutoDiv.innerHTML = '<p class="text-muted">Aguardando produto...</p>';
        inputCodigoBarras.focus();
    }
    
    /**
     * Limpa toda a venda (carrinho e pagamentos)
     */
    function cancelarVenda() {
        if (carrinho.length > 0 || pagamentos.length > 0) {
            if (confirm('Tem certeza que deseja cancelar a venda atual?')) {
                carrinho = [];
                pagamentos = []; // Limpa também os pagamentos
                renderizarCarrinho();
                limparFormularioProduto();
                modalFinalizarVenda.hide();
            }
        }
    }

    // =========================================================================
    // NOVO: Lógica de Múltiplos Pagamentos
    // =========================================================================
    
    function adicionarPagamento() {
        const forma = selectFormaPagamentoAdd.value;
        const valor = parseFloat(inputValorPagamentoAdd.value);

        if (isNaN(valor) || valor <= 0) {
            alert('Por favor, insira um valor válido para o pagamento.');
            return;
        }
        
        const totalVenda = carrinho.reduce((acc, item) => acc + item.subtotal, 0);
        const totalPagoAtual = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        
        // Adiciona o novo pagamento à lista
        pagamentos.push({
            forma_pagamento: forma,
            valor: parseFloat(valor.toFixed(2)) // Arredonda para 2 casas
        });
        
        // Limpa os inputs de pagamento
        inputValorPagamentoAdd.value = '';
        selectFormaPagamentoAdd.value = 'dinheiro';
        
        renderizarPagamentos();
        
        // Foca no campo de valor, sugerindo o valor restante
        const novoTotalPago = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        const novoValorRestante = Math.max(0, totalVenda - novoTotalPago);
        inputValorPagamentoAdd.value = novoValorRestante.toFixed(2);
        inputValorPagamentoAdd.focus();
        inputValorPagamentoAdd.select();
    }

    function renderizarPagamentos() {
        pagamentosTbody.innerHTML = '';
        let totalPago = 0;
        let totalPix = 0;
        
        const totalVenda = carrinho.reduce((acc, item) => acc + item.subtotal, 0);
        const totalVendaArredondado = parseFloat(totalVenda.toFixed(2));

        pagamentos.forEach((pagamento, index) => {
            totalPago += pagamento.valor;
            if (pagamento.forma_pagamento === 'pix') {
                totalPix += pagamento.valor;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${pagamento.forma_pagamento.charAt(0).toUpperCase() + pagamento.forma_pagamento.slice(1)}</td>
                <td>R$ ${pagamento.valor.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removerPagamento(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            pagamentosTbody.appendChild(tr);
        });
        
        const totalPagoArredondado = parseFloat(totalPago.toFixed(2));
        let troco = totalPagoArredondado - totalVendaArredondado;

        // Atualiza a seção de resumo
        modalTotalVenda.textContent = `R$ ${totalVendaArredondado.toFixed(2)}`;
        modalTotalPago.textContent = `R$ ${totalPagoArredondado.toFixed(2)}`;
        modalTroco.textContent = `R$ ${Math.max(0, troco).toFixed(2)}`;
        modalTroco.classList.remove('text-danger', 'text-primary');

        // Atualiza status e botão de confirmação
        if (totalVendaArredondado === 0) {
            btnConfirmarVenda.disabled = true;
            alertaStatus.className = 'alert alert-danger mt-3';
            alertaStatus.textContent = 'Adicione itens ao carrinho para finalizar a venda.';
        } else if (totalPagoArredondado >= totalVendaArredondado) {
            btnConfirmarVenda.disabled = false;
            alertaStatus.className = 'alert alert-success mt-3';
            alertaStatus.innerHTML = `<i class="fas fa-check-circle"></i> **Pagamento Suficiente.** Troco: R$ ${Math.max(0, troco).toFixed(2)}`;
            modalTroco.classList.add('text-primary');
        } else {
            btnConfirmarVenda.disabled = true;
            alertaStatus.className = 'alert alert-warning mt-3';
            alertaStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> **Pagamento Insuficiente.** Faltam: R$ ${(totalVendaArredondado - totalPagoArredondado).toFixed(2)}`;
            modalTroco.classList.add('text-danger');
        }
        
        // Lógica de exibição do QR Code PIX (se houver pagamento PIX)
        if (totalPix > 0) {
            campoPixQrcode.style.display = 'block';
            modalTotalPix.textContent = totalPix.toFixed(2);
        } else {
            campoPixQrcode.style.display = 'none';
        }
    }
    
    window.removerPagamento = function(index) {
        if (confirm('Tem certeza que deseja remover este pagamento?')) {
             pagamentos.splice(index, 1);
             renderizarPagamentos();
        }
    }

    // =========================================================================
    // Lógica de Envio da Venda (Finalizar)
    // =========================================================================
    async function finalizarVenda() {
        const totalVenda = carrinho.reduce((acc, item) => acc + item.subtotal, 0);
        const totalPago = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        
        // Última validação de segurança
        if (carrinho.length === 0 || totalVenda <= 0) {
            alert('Carrinho vazio ou valor zero.');
            return;
        }

        if (parseFloat(totalPago.toFixed(2)) < parseFloat(totalVenda.toFixed(2))) {
            alert('Valor total pago é insuficiente para a venda.');
            return;
        }

        // Prepara os dados para enviar
        const dadosVenda = {
            itens: carrinho.map(item => ({ id: item.id, quantidade: item.qtd })),
            // NOVO: Envia a lista de pagamentos
            pagamentos: pagamentos 
        };
        
        btnConfirmarVenda.disabled = true;
        btnConfirmarVenda.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

        try {
            const response = await fetch('/vendas/finalizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dadosVenda)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Erro desconhecido');
            }

            const result = await response.json();
            
            // Exibe o troco, que virá na mensagem de sucesso
            alert(result.success);

            // Abrir o cupom em nova janela
            window.open('/venda/cupom/' + result.venda_id, '_blank', 'width=500,height=700');
            
            // Limpa tudo
            carrinho = [];
            pagamentos = []; // Limpa pagamentos
            renderizarCarrinho();
            limparFormularioProduto();
            modalFinalizarVenda.hide(); 

        } catch (error) {
            console.error('Erro ao finalizar venda:', error);
            alert(`Erro: ${error.message}`);
        } finally {
            btnConfirmarVenda.disabled = false;
            btnConfirmarVenda.innerHTML = '<i class="fas fa-save"></i> Confirmar Venda';
        }
    }
    
    // =========================================================================
    // Funções de Busca por Nome (mantidas)
    // =========================================================================

    /**
     * Busca produtos por nome na nova API
     */
    async function buscarProdutoPorNome() {
        const termo = inputBuscaNome.value;

        if (termo.length < 2) {
            listaResultadosBusca.innerHTML = '<p class="text-center text-muted">Aguardando digitação (mín. 2 caracteres)...</p>';
            return;
        }

        listaResultadosBusca.innerHTML = '<p class="text-center text-primary"><i class="fas fa-spinner fa-spin"></i> Buscando...</p>';

        try {
            // Chama a nova API criada no app.py
            const response = await fetch(`/api/produtos/buscar?nome=${termo}`);
            if (!response.ok) {
                throw new Error('Erro ao buscar produtos');
            }
            const produtos = await response.json();
            renderizarResultadosBusca(produtos);
        } catch (error) {
            console.error('Erro na busca por nome:', error);
            listaResultadosBusca.innerHTML = '<p class="text-center text-danger">Erro ao buscar produtos.</p>';
        }
    }

    /**
     * Renderiza os resultados da busca por nome no modal
     */
    function renderizarResultadosBusca(produtos) {
        listaResultadosBusca.innerHTML = ''; // Limpa a lista

        if (produtos.length === 0) {
            listaResultadosBusca.innerHTML = '<p class="text-center text-warning">Nenhum produto encontrado.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'list-group';

        produtos.forEach(produto => {
            const li = document.createElement('a'); // Usamos <a> para ser clicável
            li.href = "#";
            li.className = 'list-group-item list-group-item-action resultado-item-busca d-flex justify-content-between align-items-center';
            
            // Armazena todos os dados do produto no próprio elemento
            li.dataset.produtoJson = JSON.stringify(produto);
            
            // Imagem (ou ícone)
            const imgHtml = produto.imagem_url
                ? `<img src="${produto.imagem_url}" alt="${produto.nome}">`
                : `<div class="d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background: #eee; margin-right: 15px; border-radius: 5px;"><i class="fas fa-image text-muted"></i></div>`;

            // Informações (Nome, Estoque)
            const infoHtml = `
                <div class="d-flex align-items-center">
                    <div class="info">
                        <span class="nome">${produto.nome}</span>
                        <span class="detalhes">Cód: ${produto.codigo_barras} | Estoque: ${produto.estoque_atual}</span>
                    </div>
                </div>
            `;
            
            // Preço
            const precoHtml = `<span class="preco">R$ ${produto.preco_venda.toFixed(2)}</span>`;

            li.innerHTML = `
                <div class="d-flex align-items-center">
                    ${imgHtml}
                    ${infoHtml}
                </div>
                ${precoHtml}
            `;
            
            // Adiciona o evento de clique
            li.addEventListener('click', selecionarProdutoDaBusca);
            
            ul.appendChild(li);
        });
        
        listaResultadosBusca.appendChild(ul);
    }

    /**
     * Ação ao clicar em um item da lista de busca
     */
    function selecionarProdutoDaBusca(e) {
        e.preventDefault();
        
        // Pega os dados do produto que armazenamos no 'dataset'
        const produto = JSON.parse(e.currentTarget.dataset.produtoJson);

        // 1. Define o 'produtoAtual' (variável global)
        // A função adicionarAoCarrinho usa 'produtoAtual'
        produtoAtual = {
            id: produto.id,
            nome: produto.nome,
            preco_venda: produto.preco_venda,
            estoque_atual: produto.estoque_atual
        };
        
        // 2. Chama a função de adicionar ao carrinho
        // O input 'quantidade' (que está fora do modal) será usado (padrão 1)
        adicionarAoCarrinho();
        
        // 3. Fecha o modal
        modalBusca.hide();
    }
    
    // =========================================================================
    // EVENT LISTENERS
    // =========================================================================

    // Busca produto ao digitar (com delay)
    let typingTimer;
    inputCodigoBarras.addEventListener('keyup', (e) => {
        clearTimeout(typingTimer);
        // Se pressionar Enter, busca e tenta adicionar imediatamente
        if (e.key === 'Enter') {
            // Passa true para forçar a busca
            buscarProduto(true).then(() => {
                if(produtoAtual) {
                    // Aqui, em vez de adicionar direto, focamos no campo quantidade para ajuste.
                    // Se o usuário pressionou enter no campo de código, ele quer o item no carrinho.
                    if (document.activeElement.id === 'codigo_barras') {
                        adicionarAoCarrinho();
                    }
                }
            });
        } else {
             // Caso contrário, espera o usuário parar de digitar
             typingTimer = setTimeout(() => {
                buscarProduto(false); 
             }, 500); // 500ms delay
        }
    });
    
    // Adicionar com botão
    btnAdicionar.addEventListener('click', adicionarAoCarrinho);
    
    // Adicionar com Enter no campo quantidade
    inputQuantidade.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            adicionarAoCarrinho(); 
        }
    });
    
    // Botões de ação
    btnCancelar.addEventListener('click', cancelarVenda);
    btnConfirmarVenda.addEventListener('click', finalizarVenda);
    btnAdicionarPagamento.addEventListener('click', adicionarPagamento); // NOVO LISTENER
    
    // Lógica para adicionar pagamento com Enter no campo de valor do pagamento
    inputValorPagamentoAdd.addEventListener('keydown', (e) => {
         if (e.key === 'Enter') {
             e.preventDefault();
             adicionarPagamento();
         }
    });
    
    // Atalhos do teclado 
    document.addEventListener('keydown', (e) => {
        
        if (e.key === 'F2') {
            e.preventDefault();
            modalBusca.show();
        }
        
        if (e.key === 'F6') {
            e.preventDefault();
            if(carrinho.length > 0) {
                // Ao abrir, atualizamos o modal de pagamentos e a sugestão inicial
                const totalVenda = carrinho.reduce((acc, item) => acc + item.subtotal, 0);
                inputValorPagamentoAdd.value = totalVenda.toFixed(2);
                selectFormaPagamentoAdd.value = 'dinheiro'; // Sugere dinheiro como padrão
                
                // Limpa pagamentos anteriores, para que o PDV comece "limpo" a cada F6
                pagamentos = [];
                
                renderizarPagamentos();
                modalFinalizarVenda.show(); 
            }
        }
        if (e.key === 'F3') {
            e.preventDefault();
            cancelarVenda();
        }
    });

    // Foca o input de busca quando o modal abrir
    document.getElementById('modalBuscarProduto').addEventListener('shown.bs.modal', function () {
        inputBuscaNome.focus();
        inputBuscaNome.select();
    });
    
    // Limpa o input de busca quando o modal fechar
    document.getElementById('modalBuscarProduto').addEventListener('hidden.bs.modal', function () {
        inputBuscaNome.value = '';
        listaResultadosBusca.innerHTML = '<p class="text-center text-muted">Aguardando digitação (mín. 2 caracteres)...</p>';
    });
    
    // Foco e sugestão de pagamento no modal de finalização ao abrir
    document.getElementById('modalFinalizar').addEventListener('shown.bs.modal', function () {
        const totalVenda = carrinho.reduce((acc, item) => acc + item.subtotal, 0);
        // Sugere o valor restante ou total da venda como primeiro pagamento
        const totalPagoAtual = pagamentos.reduce((acc, p) => acc + p.valor, 0);
        const valorRestante = Math.max(0, totalVenda - totalPagoAtual);
        
        inputValorPagamentoAdd.value = valorRestante.toFixed(2);
        selectFormaPagamentoAdd.value = 'dinheiro'; // Sugere dinheiro como padrão
        inputValorPagamentoAdd.focus();
        inputValorPagamentoAdd.select();

        renderizarPagamentos();
    });

    // Evento de digitação no input de busca (com debounce)
    inputBuscaNome.addEventListener('keyup', (e) => {
        clearTimeout(buscaTypingTimer);
        
        // Se o usuário pressionar Enter na busca, não faz nada (ele deve clicar)
        if (e.key === 'Enter') {
            e.preventDefault();
            return;
        }
        
        buscaTypingTimer = setTimeout(buscarProdutoPorNome, 300); // 300ms de espera
    });

    // Inicializa a tela
    renderizarCarrinho();
    limparFormularioProduto();
});
</script>
{% endblock %}