{% extends "base.html" %}

{% block title %}Relatórios de Vendas - Sistema de Caixa{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-chart-line"></i> Relatórios de Vendas e Pagamentos</h1>
</div>

<form method="GET" class="mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="data_inicio" class="form-label">Data Início:</label>
            <input type="date" class="form-control" id="data_inicio" name="inicio" value="{{ data_inicio }}">
        </div>
        <div class="col-md-3">
            <label for="data_fim" class="form-label">Data Fim:</label>
            <input type="date" class="form-control" id="data_fim" name="fim" value="{{ data_fim }}">
        </div>
        <div class="col-md-3">
            <label for="caixa_id" class="form-label">Caixa (Operador):</label>
            <select class="form-select" id="caixa_id" name="caixa_id">
                <option value="0" {% if caixa_selecionado == 0 %}selected{% endif %}>Todos os Caixas</option>
                {% for caixa in caixas %}
                <option value="{{ caixa.id }}" {% if caixa.id == caixa_selecionado %}selected{% endif %}>{{ caixa.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="forma_pgto" class="form-label">Forma de Pagamento (Filtro):</label>
            <select class="form-select" id="forma_pgto" name="forma_pgto">
                <option value="todos" {% if forma_pgto_selecionada == 'todos' %}selected{% endif %}>Todas as Formas</option>
                <option value="dinheiro" {% if forma_pgto_selecionada == 'dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="cartao" {% if forma_pgto_selecionada == 'cartao' %}selected{% endif %}>Cartão</option>
                <option value="pix" {% if forma_pgto_selecionada == 'pix' %}selected{% endif %}>PIX</option>
                <option value="outros" {% if forma_pgto_selecionada == 'outros' %}selected{% endif %}>Outras Formas</option>
            </select>
        </div>
        <div class="col-md-12 d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter"></i> Aplicar Filtro
            </button>
            <a href="{{ url_for('exportar_relatorio', inicio=data_inicio, fim=data_fim, caixa_id=caixa_selecionado, forma_pgto=forma_pgto_selecionada) }}" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
            <!-- NOVO BOTÃO para o Relatório de Recebimentos Consolidados -->
            <a href="{{ url_for('relatorio_recebimentos_consolidados', inicio=data_inicio, fim=data_fim, caixa_id=caixa_selecionado) }}" class="btn btn-info text-white">
                <i class="fas fa-dollar-sign"></i> Recebimentos Consolidados
            </a>
        </div>
    </div>
</form>

<div class="row">
    <!-- Resumo de Vendas (Mantido) -->
    <div class="col-md-4 mb-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-0">Total Vendido</h6>
                        <h4 class="mb-0">R$ {{ "%.2f"|format(total_vendido) }}</h4>
                    </div>
                    <i class="fas fa-money-bill-wave fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-0">Total de Vendas</h6>
                        <h4 class="mb-0">{{ num_vendas }}</h4>
                    </div>
                    <i class="fas fa-receipt fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card text-white bg-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-0">Ticket Médio</h6>
                        <h4 class="mb-0">R$ {{ "%.2f"|format(ticket_medio) }}</h4>
                    </div>
                    <i class="fas fa-calculator fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs" id="relatoriosTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="vendas-tab" data-bs-toggle="tab" data-bs-target="#vendas" type="button" role="tab" aria-controls="vendas" aria-selected="true">
            <i class="fas fa-list"></i> Detalhe de Vendas
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button" role="tab" aria-controls="produtos" aria-selected="false">
            <i class="fas fa-chart-simple"></i> Top 10 Produtos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pagamentos-tab" data-bs-toggle="tab" data-bs-target="#pagamentos" type="button" role="tab" aria-controls="pagamentos" aria-selected="false">
            <i class="fas fa-credit-card"></i> Pagamentos Agrupados (Geral)
        </button>
    </li>
</ul>

<div class="tab-content" id="relatoriosTabContent">
    
    <!-- Tab 1: Detalhe de Vendas (Mantida) -->
    <div class="tab-pane fade show active" id="vendas" role="tabpanel" aria-labelledby="vendas-tab">
        <h5 class="mt-3">Vendas Detalhadas no Período ({{ nome_filtro }})</h5>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Nº Venda</th>
                        <th>Data/Hora</th>
                        <th>Operador</th>
                        <th>Itens (Qtd)</th>
                        <th>Valor Total</th>
                        <th>Valor Pago</th>
                        <th>Troco</th>
                        <th>Formas Pgto</th>
                        <th>Status</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens_vendidos_detalhe %}
                    <tr>
                        <td><a href="{{ url_for('cupom_venda', venda_id=item.venda.id) }}" target="_blank" class="fw-bold text-decoration-none">{{ item.venda.numero_venda }}</a></td>
                        <td>{{ item.venda.data_venda.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ item.venda.operador.nome }}</td>
                        <td>{{ item.produto.nome }} ({{ item.quantidade }})</td>
                        <td class="text-nowrap">R$ {{ "%.2f"|format(item.venda.valor_total) }}</td>
                        <td class="text-nowrap">R$ {{ "%.2f"|format(item.venda.valor_pago) }}</td>
                        <td class="text-nowrap">R$ {{ "%.2f"|format(item.venda.troco) }}</td>
                        <td>{{ item.venda.formas_pagamento_usadas }}</td>
                        <td>
                            {% if item.venda.status == 'cancelada' %}
                            <span class="badge bg-danger">Cancelada</span>
                            {% else %}
                            <span class="badge bg-success">Finalizada</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.venda.status != 'cancelada' %}
                            <form action="{{ url_for('vendas_cancelar', venda_id=item.venda.id, inicio=data_inicio, fim=data_fim, caixa_id=caixa_selecionado, forma_pgto=forma_pgto_selecionada) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja cancelar a Venda #{{ item.venda.numero_venda }}? Isso irá reverter o estoque e não pode ser desfeito!');" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" title="Cancelar Venda">
                                    <i class="fas fa-undo"></i> Estornar
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab 2: Top 10 Produtos (Mantida) -->
    <div class="tab-pane fade" id="produtos" role="tabpanel" aria-labelledby="produtos-tab">
        <h5 class="mt-3">Top 10 Produtos Mais Vendidos ({{ nome_filtro }})</h5>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Cód. Barras</th>
                        <th>Total Vendido (R$)</th>
                        <th>Total em Unidades</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produto in produtos_vendidos %}
                    <tr>
                        <td>{{ produto.nome }}</td>
                        <td>{{ produto.codigo_barras }}</td>
                        <td class="text-nowrap">R$ {{ "%.2f"|format(produto.total_arrecadado) }}</td>
                        <td>{{ produto.total_quantidade }} un.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab 3: Pagamentos Agrupados (Mantida e Melhorada) -->
    <div class="tab-pane fade" id="pagamentos" role="tabpanel" aria-labelledby="pagamentos-tab">
        <h5 class="mt-3">Totais Agrupados por Forma de Pagamento ({{ nome_filtro }})</h5>
        <div class="table-responsive">
            <table class="table table-striped table-sm w-50">
                <thead>
                    <tr>
                        <th>Forma de Pagamento</th>
                        <th class="text-end">Total Recebido (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    {% set total_recebido_geral = 0 %}
                    {% for forma, total in pagamentos_agrupados %}
                    <tr>
                        <td>
                            <i class="{% if forma == 'dinheiro' %}fas fa-money-bill-wave{% elif forma == 'cartao' %}fas fa-credit-card{% elif forma == 'pix' %}fas fa-qrcode{% else %}fas fa-wallet{% endif %} me-2"></i>
                            {{ forma.title() }}
                        </td>
                        <td class="text-end fw-bold text-success">R$ {{ "%.2f"|format(total) }}</td>
                    </tr>
                    {% set total_recebido_geral = total_recebido_geral + total %}
                    {% endfor %}
                    <tr>
                        <td class="fw-bold bg-light">TOTAL DE RECEBIMENTOS (VENDAS FINALIZADAS)</td>
                        <td class="text-end fw-bold bg-light text-primary">R$ {{ "%.2f"|format(total_recebido_geral) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}